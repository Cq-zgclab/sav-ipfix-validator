<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯Šæ–­å·¥å…· - SAV IPFIX</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { 
            color: #00ff88;
            margin-bottom: 20px;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 10px;
        }
        h2 {
            color: #4fc3f7;
            margin: 20px 0 10px 0;
        }
        .section {
            background: #16213e;
            border: 1px solid #0f3460;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }
        .log {
            background: #0a0e27;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #00ff88;
            font-size: 14px;
        }
        .log.info { border-left-color: #4fc3f7; }
        .log.warn { border-left-color: #ffd54f; color: #ffd54f; }
        .log.error { border-left-color: #ff5252; color: #ff5252; }
        .log.success { border-left-color: #00ff88; color: #00ff88; }
        
        button {
            background: #00ff88;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        button:hover { 
            background: #00cc6f;
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #0f3460;
        }
        th {
            background: #0f3460;
            color: #00ff88;
            font-weight: bold;
        }
        td {
            background: #16213e;
        }
        
        pre {
            background: #0a0e27;
            padding: 15px;
            overflow-x: auto;
            border-radius: 4px;
            border: 1px solid #0f3460;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-ok { background: #00ff88; color: #1a1a2e; }
        .status-fail { background: #ff5252; color: white; }
        .status-unknown { background: #757575; color: white; }
        
        #realtime-log {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ SAV IPFIX Web è¯Šæ–­å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸŒ ç¯å¢ƒä¿¡æ¯</h2>
            <table id="env-info">
                <tr><th>é¡¹ç›®</th><th>å€¼</th></tr>
            </table>
        </div>

        <div class="section">
            <h2>ğŸ§ª å¿«é€Ÿæµ‹è¯•</h2>
            <div class="btn-group">
                <button onclick="testBasic()">1ï¸âƒ£ åŸºç¡€æµ‹è¯•</button>
                <button onclick="testDataJson()">2ï¸âƒ£ æµ‹è¯•data.json</button>
                <button onclick="testAllPages()">3ï¸âƒ£ æµ‹è¯•æ‰€æœ‰é¡µé¢</button>
                <button onclick="testCORS()">4ï¸âƒ£ CORSæµ‹è¯•</button>
                <button onclick="testHeaders()">5ï¸âƒ£ å“åº”å¤´æµ‹è¯•</button>
                <button onclick="runFullDiagnostic()">ğŸš€ å®Œæ•´è¯Šæ–­</button>
                <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“Š å®æ—¶æ—¥å¿—</h2>
            <div id="realtime-log"></div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ æµ‹è¯•ç»“æœæ‘˜è¦</h2>
            <div id="summary"></div>
        </div>
    </div>

    <script>
        const logContainer = document.getElementById('realtime-log');
        const summaryContainer = document.getElementById('summary');
        const results = {
            basic: null,
            dataJson: null,
            pages: {},
            cors: null,
            headers: null
        };

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            div.innerHTML = `[${timestamp}] ${message}`;
            logContainer.insertBefore(div, logContainer.firstChild);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            logContainer.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // æ”¶é›†ç¯å¢ƒä¿¡æ¯
        function collectEnvInfo() {
            const envTable = document.getElementById('env-info');
            const info = [
                ['User Agent', navigator.userAgent],
                ['Platform', navigator.platform],
                ['Language', navigator.language],
                ['Online', navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'],
                ['Cookie Enabled', navigator.cookieEnabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'],
                ['å½“å‰URL', window.location.href],
                ['åè®®', window.location.protocol],
                ['ä¸»æœº', window.location.host],
                ['è·¯å¾„', window.location.pathname],
                ['å±å¹•åˆ†è¾¨ç‡', `${screen.width}x${screen.height}`],
                ['è§†å£å¤§å°', `${window.innerWidth}x${window.innerHeight}`],
                ['æ—¶åŒº', Intl.DateTimeFormat().resolvedOptions().timeZone],
                ['å½“å‰æ—¶é—´', new Date().toLocaleString('zh-CN')]
            ];

            info.forEach(([key, value]) => {
                const row = envTable.insertRow();
                row.insertCell(0).textContent = key;
                row.insertCell(1).textContent = value;
            });

            log('ç¯å¢ƒä¿¡æ¯æ”¶é›†å®Œæˆ', 'success');
        }

        // åŸºç¡€æµ‹è¯•
        async function testBasic() {
            log('å¼€å§‹åŸºç¡€æµ‹è¯•...', 'info');
            
            try {
                // æµ‹è¯•1: DOM API
                log('æµ‹è¯• DOM API...', 'info');
                const testDiv = document.createElement('div');
                testDiv.textContent = 'Test';
                log('âœ… DOM API æ­£å¸¸', 'success');

                // æµ‹è¯•2: Console API
                log('æµ‹è¯• Console API...', 'info');
                console.log('Console test');
                log('âœ… Console API æ­£å¸¸', 'success');

                // æµ‹è¯•3: Fetch API
                log('æµ‹è¯• Fetch API å¯ç”¨æ€§...', 'info');
                if (typeof fetch === 'function') {
                    log('âœ… Fetch API å¯ç”¨', 'success');
                } else {
                    log('âŒ Fetch API ä¸å¯ç”¨', 'error');
                }

                // æµ‹è¯•4: Promise
                log('æµ‹è¯• Promise...', 'info');
                await new Promise(resolve => setTimeout(resolve, 100));
                log('âœ… Promise æ­£å¸¸', 'success');

                // æµ‹è¯•5: JSON
                log('æµ‹è¯• JSON API...', 'info');
                const testObj = { test: true };
                JSON.stringify(testObj);
                JSON.parse('{"test":true}');
                log('âœ… JSON API æ­£å¸¸', 'success');

                results.basic = true;
                log('ğŸ‰ åŸºç¡€æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');
            } catch (error) {
                results.basic = false;
                log(`âŒ åŸºç¡€æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
            
            updateSummary();
        }

        // æµ‹è¯• data.json
        async function testDataJson() {
            log('å¼€å§‹æµ‹è¯• data.json...', 'info');
            
            try {
                log('å‘èµ· GET è¯·æ±‚: data.json', 'info');
                const startTime = performance.now();
                
                const response = await fetch('data.json');
                const loadTime = (performance.now() - startTime).toFixed(2);
                
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                log(`å“åº”æ—¶é—´: ${loadTime}ms`, 'info');
                log(`Content-Type: ${response.headers.get('content-type')}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                log('âœ… JSON è§£ææˆåŠŸ', 'success');
                log(`æ€»è®°å½•æ•°: ${data.totalRecords}`, 'info');
                log(`IPç‰ˆæœ¬: ${data.ipVersion}`, 'info');
                log(`è®°å½•æ•°ç»„é•¿åº¦: ${data.records.length}`, 'info');
                
                if (data.records.length > 0) {
                    const firstRecord = data.records[0];
                    log(`ç¬¬ä¸€æ¡è®°å½•è§„åˆ™æ•°: ${firstRecord.rules.length}`, 'info');
                }
                
                results.dataJson = true;
                log('ğŸ‰ data.json æµ‹è¯•é€šè¿‡ï¼', 'success');
                
                // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                const preview = document.createElement('pre');
                preview.textContent = JSON.stringify(data, null, 2).substring(0, 500) + '\n...';
                logContainer.insertBefore(preview, logContainer.firstChild);
                
            } catch (error) {
                results.dataJson = false;
                log(`âŒ data.json æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
            
            updateSummary();
        }

        // æµ‹è¯•æ‰€æœ‰é¡µé¢
        async function testAllPages() {
            const pages = [
                'index.html',
                'test.html',
                'debug.html',
                'static.html',
                'ultimate.html',
                'diagnostic.html'
            ];
            
            log(`å¼€å§‹æµ‹è¯• ${pages.length} ä¸ªé¡µé¢...`, 'info');
            
            for (const page of pages) {
                try {
                    log(`æµ‹è¯•: ${page}`, 'info');
                    const response = await fetch(page);
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        const size = response.headers.get('content-length') || 'æœªçŸ¥';
                        log(`âœ… ${page} - ${response.status} (${contentType}, ${size} bytes)`, 'success');
                        results.pages[page] = true;
                    } else {
                        log(`âš ï¸ ${page} - ${response.status} ${response.statusText}`, 'warn');
                        results.pages[page] = false;
                    }
                } catch (error) {
                    log(`âŒ ${page} - ${error.message}`, 'error');
                    results.pages[page] = false;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log('é¡µé¢æµ‹è¯•å®Œæˆ', 'success');
            updateSummary();
        }

        // CORS æµ‹è¯•
        async function testCORS() {
            log('å¼€å§‹ CORS æµ‹è¯•...', 'info');
            
            try {
                const response = await fetch('data.json', {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'same-origin'
                });
                
                log(`CORS Mode: cors`, 'info');
                log(`Status: ${response.status}`, 'info');
                
                const corsHeaders = [
                    'access-control-allow-origin',
                    'access-control-allow-methods',
                    'access-control-allow-headers'
                ];
                
                corsHeaders.forEach(header => {
                    const value = response.headers.get(header);
                    if (value) {
                        log(`âœ… ${header}: ${value}`, 'success');
                    } else {
                        log(`â„¹ï¸ ${header}: (æœªè®¾ç½®)`, 'info');
                    }
                });
                
                results.cors = true;
                log('CORS æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                results.cors = false;
                log(`âŒ CORS æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        // å“åº”å¤´æµ‹è¯•
        async function testHeaders() {
            log('å¼€å§‹å“åº”å¤´æµ‹è¯•...', 'info');
            
            try {
                const response = await fetch('data.json');
                
                log('æ‰€æœ‰å“åº”å¤´:', 'info');
                const headersTable = document.createElement('table');
                headersTable.innerHTML = '<tr><th>Header</th><th>Value</th></tr>';
                
                for (const [key, value] of response.headers.entries()) {
                    log(`${key}: ${value}`, 'info');
                    const row = headersTable.insertRow();
                    row.insertCell(0).textContent = key;
                    row.insertCell(1).textContent = value;
                }
                
                logContainer.insertBefore(headersTable, logContainer.firstChild);
                
                results.headers = true;
                log('å“åº”å¤´æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                results.headers = false;
                log(`âŒ å“åº”å¤´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        // å®Œæ•´è¯Šæ–­
        async function runFullDiagnostic() {
            log('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­æµç¨‹...', 'info');
            clearLogs();
            
            await testBasic();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDataJson();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAllPages();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCORS();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testHeaders();
            
            log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆï¼', 'success');
            log('è¯·æŸ¥çœ‹ä¸Šæ–¹çš„æµ‹è¯•ç»“æœæ‘˜è¦', 'info');
        }

        // æ›´æ–°æ‘˜è¦
        function updateSummary() {
            let html = '<table><tr><th>æµ‹è¯•é¡¹</th><th>çŠ¶æ€</th></tr>';
            
            const addRow = (name, status) => {
                const badge = status === true ? 
                    '<span class="status-badge status-ok">âœ… é€šè¿‡</span>' :
                    status === false ?
                    '<span class="status-badge status-fail">âŒ å¤±è´¥</span>' :
                    '<span class="status-badge status-unknown">â³ æœªæµ‹è¯•</span>';
                html += `<tr><td>${name}</td><td>${badge}</td></tr>`;
            };
            
            addRow('åŸºç¡€åŠŸèƒ½', results.basic);
            addRow('data.jsonåŠ è½½', results.dataJson);
            addRow('CORS', results.cors);
            addRow('å“åº”å¤´', results.headers);
            
            for (const [page, status] of Object.entries(results.pages)) {
                addRow(`é¡µé¢: ${page}`, status);
            }
            
            html += '</table>';
            summaryContainer.innerHTML = html;
        }

        // å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', (event) => {
            log(`ğŸ”¥ å…¨å±€é”™è¯¯: ${event.message} (${event.filename}:${event.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`ğŸ”¥ æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error');
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ', 'success');
            collectEnvInfo();
            updateSummary();
            
            log('ğŸ’¡ æç¤º: ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
            log('å»ºè®®å…ˆè¿è¡Œ"å®Œæ•´è¯Šæ–­"è·å–å…¨éƒ¨ä¿¡æ¯', 'info');
        });

        log('ğŸ”¬ è¯Šæ–­å·¥å…·å·²åˆå§‹åŒ–', 'success');
    </script>
</body>
</html>
